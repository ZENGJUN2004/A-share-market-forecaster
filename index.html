<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI äº¤æ˜“é—­ç¯ç³»ç»Ÿ (å¤šå‘¨æœŸç­–ç•¥ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .tab-active { background-color: #2563eb; color: white; border-color: #3b82f6; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="h-16 border-b border-slate-700 bg-slate-900 flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center text-white font-bold">AI</div>
            <div class="flex flex-col">
                <h1 class="font-bold text-lg leading-tight">Aè‚¡é¢„æµ‹å¸ˆ</h1>
                <div id="realTimeClock" class="text-[10px] text-blue-400 font-mono">è½½å…¥æ—¶é—´ä¸­...</div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="marketStatus" class="text-xs px-2 py-1 rounded bg-slate-800 text-slate-400 border border-slate-700">æ£€æµ‹å¸‚åœºæ—¶æ®µ...</div>
            <div class="flex items-center gap-2 bg-slate-800 rounded px-3 py-1">
                <i class="fa-solid fa-key text-yellow-500 text-xs"></i>
                <input type="password" id="apiKeyInput" placeholder="è¾“å…¥ API Key" class="bg-transparent border-none outline-none text-sm w-40 text-white placeholder-slate-500">
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <main class="flex-1 flex flex-col p-6 gap-6 overflow-y-auto scrollbar-hide">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-2 text-blue-400">1. è”ç½‘é¢„æµ‹ (10æ¬¡é›†æˆ)</h2>
                    
                    <div class="flex gap-2 mb-4 p-1 bg-slate-800 rounded-lg w-fit">
                        <button onclick="setPeriod('day')" id="p-day" class="period-btn px-3 py-1 text-xs rounded-md border border-transparent transition tab-active">å½“æ—¥</button>
                        <button onclick="setPeriod('week')" id="p-week" class="period-btn px-3 py-1 text-xs rounded-md border border-transparent transition text-slate-400">ä¸€å‘¨</button>
                        <button onclick="setPeriod('month')" id="p-month" class="period-btn px-3 py-1 text-xs rounded-md border border-transparent transition text-slate-400">ä¸€æœˆ</button>
                        <button onclick="setPeriod('halfyear')" id="p-halfyear" class="period-btn px-3 py-1 text-xs rounded-md border border-transparent transition text-slate-400">åŠå¹´</button>
                    </div>

                    <p id="predictTargetDesc" class="text-sm text-slate-400 mb-4">æ­£åœ¨è®¡ç®—é¢„æµ‹ç›®æ ‡...</p>
                    <div id="newsDisplay" class="text-xs text-slate-300 mb-4 h-10 overflow-hidden">ç­‰å¾…è”ç½‘...</div>
                    <button id="btnPredict" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded">å¯åŠ¨é¢„æµ‹</button>
                </div>

                <div class="glass rounded-xl p-6">
                    <div class="flex justify-between items-start mb-2">
                        <h2 class="text-xl font-bold text-green-400">2. æ”¶ç›˜å¤ç›˜</h2>
                        <button id="btnAutoFetch" class="text-[10px] bg-slate-700 hover:bg-slate-600 text-slate-300 px-2 py-1 rounded transition">
                            <i class="fa-solid fa-cloud-download mr-1"></i>è‡ªåŠ¨è·å–ä»Šæ—¥æ”¶ç›˜
                        </button>
                    </div>
                    <p class="text-sm text-slate-400 mb-4">è¾“å…¥çœŸå®ç»“æœ -> å¼ºåŒ–æƒé‡</p>
                    <div class="flex gap-2 mb-4">
                        <input type="number" id="realClose" placeholder="æ”¶ç›˜ä»·/ç‚¹ä½" class="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm w-full text-white">
                        <input type="number" id="realChange" placeholder="æ¶¨è·Œå¹…%" class="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm w-full text-white">
                    </div>
                    <button id="btnReview" disabled class="w-full bg-slate-700 text-slate-400 font-bold py-2 rounded cursor-not-allowed">æ‰§è¡Œå¤ç›˜</button>
                </div>
            </div>

            <div class="glass rounded-xl p-6 flex-1 min-h-[300px] flex flex-col">
                <h3 class="font-bold mb-4">å†å²å‡†ç¡®ç‡æ›²çº¿</h3>
                <div class="relative w-full h-full">
                    <canvas id="historyChart"></canvas>
                </div>
            </div>
        </main>

        <aside class="w-80 bg-slate-900 border-l border-slate-700 flex flex-col shrink-0">
            <div class="p-4 border-b border-slate-700 font-bold text-sm text-slate-400">ç³»ç»Ÿæ—¥å¿—</div>
            <div id="logContainer" class="flex-1 overflow-y-auto p-4 font-mono text-xs space-y-2"></div>
            <div class="p-4 border-t border-slate-700 bg-slate-800">
                <div class="text-xs text-slate-400 mb-1">å½“å‰æ¨¡å‹æƒé‡</div>
                <div id="weightDisplay" class="text-2xl font-bold text-white">1.000</div>
            </div>
        </aside>
    </div>

    <script>
        const CONFIG = {
            apiRawEndpoint: 'https://api.siliconflow.cn/v1/chat/completions',
            model: 'Qwen/Qwen2.5-7B-Instruct',
            storageKey: 'ai_trading_history_v2',
            marketDataApi: 'https://qt.gtimg.cn/q=s_sh000001'
        };

        const $ = id => document.getElementById(id);
        let currentPeriod = 'day';

        // --- å®æ—¶åŠŸèƒ½ & å‘¨æœŸé€»è¾‘ ---
        function setPeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('tab-active', 'text-white');
                btn.classList.add('text-slate-400');
            });
            $(`p-${period}`).classList.add('tab-active', 'text-white');
            updateClock(); 
        }

        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', { hour12: false });
            $('realTimeClock').innerText = timeStr;

            const hour = now.getHours();
            const minute = now.getMinutes();
            const totalMinutes = hour * 60 + minute;

            let statusText = (totalMinutes < 570) ? "ğŸ”´ ç›˜å‰" : (totalMinutes >= 900) ? "ğŸ”µ ç›˜å" : "ğŸŸ¢ äº¤æ˜“ä¸­";
            $('marketStatus').innerText = statusText;

            const periodNames = { day: 'å½“æ—¥', week: 'æœªæ¥ä¸€å‘¨', month: 'æœªæ¥ä¸€æœˆ', halfyear: 'æœªæ¥åŠå¹´' };
            let targetLabel = periodNames[currentPeriod];
            
            // é’ˆå¯¹å½“æ—¥çš„ç‰¹æ®Šæ—¶é—´é€»è¾‘
            if(currentPeriod === 'day') {
                targetLabel = totalMinutes < 570 ? "ã€ä»Šæ—¥ã€‘æ”¶ç›˜" : totalMinutes >= 810 ? "ã€æ¬¡æ—¥ã€‘èµ°åŠ¿" : "ã€å³æ—¶ã€‘æ³¢åŠ¨";
            }
            $('predictTargetDesc').innerText = `é¢„æµ‹ç›®æ ‡ï¼š${targetLabel}`;
        }
        setInterval(updateClock, 1000);

        // --- æ ¸å¿ƒï¼šå¤šç»´åº¦é¢„æµ‹ç®—æ³•é€»è¾‘ ---
        function getAlgorithmPrompt(news) {
            const base = `å‚è€ƒæ•°æ®ï¼š${news}\nå½“å‰å‘¨æœŸï¼š${currentPeriod}\n`;
            const algos = {
                day: `ç®—æ³•ï¼š[æ—¥å†…æƒ…ç»ªé‡åŒ–]ã€‚è¯·åˆ†æè¶…çŸ­çº¿èµ„é‡‘æµå‘ã€å³æ—¶æ–°é—»å†²å‡»åŠç›˜é¢åŠ¨é‡ã€‚`,
                week: `ç®—æ³•ï¼š[æ³¢æ®µè¶‹åŠ¿åˆ†æ]ã€‚è¯·ç»“åˆæœ¬å‘¨é‡è¦å®è§‚æ•°æ®é¢„å‘Šã€è¡Œä¸šå‘¨åº¦æ™¯æ°”åº¦åŠæŠ€æœ¯é¢æ”¯æ’‘å‹åŠ›ã€‚`,
                month: `ç®—æ³•ï¼š[ä¸­æœŸç­–ç•¥æ¨æ¼”]ã€‚è¯·åˆ†ææœ¬æœˆæ”¿ç­–å¯¼å‘ã€æµåŠ¨æ€§é¢„æœŸï¼ˆå¤®è¡ŒåŠ¨å‘ï¼‰åŠæ ¸å¿ƒèµ„äº§ä¼°å€¼ä¸­æ¢ã€‚`,
                halfyear: `ç®—æ³•ï¼š[å®è§‚å‘¨æœŸå»ºæ¨¡]ã€‚è¯·åˆ†æäº§ä¸šç”Ÿå‘½å‘¨æœŸã€åŠå¹´åº¦è´¢æŠ¥é¢„æœŸåŠå…¨çƒå®è§‚åšå¼ˆï¼ˆæ±‡ç‡/åˆ©ç‡å‘¨æœŸï¼‰ã€‚`
            };
            return base + algos[currentPeriod] + `\nä»»åŠ¡ï¼šä¸¥æ ¼ä»…è¾“å‡ºâ€œå¤§æ¶¨ã€å°æ¶¨ã€å¹³ã€å°è·Œã€å¤§è·Œâ€äº”ä¸ªè¯ä¸­çš„ä¸€ä¸ªã€‚`;
        }

        // --- è‡ªåŠ¨è·å–æ•°æ® ---
        $('btnAutoFetch').addEventListener('click', async () => {
            const btn = $('btnAutoFetch');
            btn.innerHTML = '...';
            try {
                const response = await fetch('https://corsproxy.io/?' + encodeURIComponent(CONFIG.marketDataApi));
                const parts = (await response.text()).split('~');
                if (parts.length > 4) {
                    $('realClose').value = parts[2];
                    $('realChange').value = parts[4];
                    log(`è·å–æˆåŠŸï¼š${parts[4]}%`, 'success');
                }
            } catch (e) { log('è·å–å¤±è´¥', 'error'); }
            btn.innerHTML = '<i class="fa-solid fa-cloud-download mr-1"></i>è‡ªåŠ¨è·å–ä»Šæ—¥æ”¶ç›˜';
        });

        // --- LLM ä¸ ä¸šåŠ¡æµ ---
        const log = (msg, type='info') => {
            const el = document.createElement('div');
            el.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString()}] </span><span class="${type==='success'?'text-green-400':type==='error'?'text-red-400':''}">${msg}</span>`;
            $('logContainer').appendChild(el);
            $('logContainer').scrollTop = $('logContainer').scrollHeight;
        };

        async function callLLM(apiKey, prompt) {
            const response = await fetch('https://corsproxy.io/?' + encodeURIComponent(CONFIG.apiRawEndpoint), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey.trim()}` },
                body: JSON.stringify({
                    model: CONFIG.model,
                    messages: [{ role: "system", content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é‡‘èé‡åŒ–ç­–ç•¥å¸ˆã€‚" }, { role: "user", content: prompt }],
                    temperature: 0.7, max_tokens: 100
                })
            });
            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        $('btnPredict').addEventListener('click', async () => {
            const apiKey = $('apiKeyInput').value;
            if(!apiKey) return alert('è¯·è¾“å…¥ API Key');
            
            $('btnPredict').disabled = true;
            $('btnPredict').innerText = 'å¤šç»´ç®—æ³•è®¡ç®—ä¸­...';
            
            try {
                const news = `å¸‚åœºæ³¢åŠ¨ï¼š${$('marketStatus').innerText}ï¼Œå½“å‰å‘¨æœŸåå¥½ï¼š${currentPeriod}`;
                $('newsDisplay').innerText = `æ­£åœ¨åº”ç”¨${currentPeriod}ç®—æ³•åˆ†æå®æ—¶æ•°æ®...`;
                
                const options = ["å¤§æ¶¨", "å°æ¶¨", "å¹³", "å°è·Œ", "å¤§è·Œ"];
                const results = [];
                for (let i = 0; i < 10; i++) {
                    const res = await callLLM(apiKey, getAlgorithmPrompt(news));
                    results.push(options.find(opt => res.includes(opt)) || "å¹³");
                }

                const counts = {};
                results.forEach(r => counts[r] = (counts[r] || 0) + 1);
                const final = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                
                log(`[${currentPeriod}]é¢„æµ‹ï¼š${final} (æƒé‡ç³»æ•°å½±å“ä¸­)`, 'success');
                window.currentPrediction = final;
                $('btnReview').disabled = false;
                $('btnReview').className = "w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded";
            } catch(e) { log('é¢„æµ‹å¤±è´¥: ' + e.message, 'error'); }
            finally { $('btnPredict').disabled = false; $('btnPredict').innerText = 'å¯åŠ¨é¢„æµ‹'; }
        });

        $('btnReview').addEventListener('click', async () => {
            const apiKey = $('apiKeyInput').value;
            const change = $('realChange').value;
            if(!change) return alert('è¯·å…ˆè·å–çœŸå®æ•°æ®');
            
            $('btnReview').innerText = 'å¼ºåŒ–å­¦ä¹ ä¸­...';
            try {
                let adjust = 0;
                for (let i = 0; i < 5; i++) {
                    const res = await callLLM(apiKey, `å‘¨æœŸ:${currentPeriod}, é¢„æµ‹:${window.currentPrediction}, çœŸå®:${change}%ã€‚ç»™å‡ºä¸€ä¸ª0.8-1.2çš„è°ƒæ•´ç³»æ•°ã€‚ä»…è¾“å‡ºæ•°å­—ã€‚`);
                    adjust += parseFloat(res.match(/\d+(\.\d+)?/)?.[0] || 1);
                }
                let history = JSON.parse(localStorage.getItem(CONFIG.storageKey) || '[]');
                let curW = history.length > 0 ? history[history.length-1].newWeight : 1.0;
                let newW = Math.max(0.1, Math.min(2.0, curW * (adjust/5)));

                history.push({ date: new Date().toLocaleDateString(), isCorrect: (parseFloat(change) > 0 && window.currentPrediction.includes("æ¶¨")), newWeight: newW });
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(history));
                
                log(`å¤ç›˜å®Œæˆã€‚æ–°æƒé‡ï¼š${newW.toFixed(3)}`, 'success');
                loadHistory();
                $('btnReview').disabled = true;
                $('btnReview').className = "w-full bg-slate-700 text-slate-400 font-bold py-2 rounded cursor-not-allowed";
            } catch(e) { log('å¤ç›˜å¤±è´¥', 'error'); }
        });

        // --- å›¾è¡¨é€»è¾‘ ---
        let historyChart;
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem(CONFIG.storageKey) || '[]');
            const accuracy = history.map((d, i) => (history.slice(0, i+1).filter(x=>x.isCorrect).length / (i+1)).toFixed(2));
            historyChart.data.labels = history.map(d => d.date);
            historyChart.data.datasets[0].data = accuracy;
            historyChart.update();
            if(history.length > 0) $('weightDisplay').innerText = history[history.length-1].newWeight.toFixed(3);
        }

        window.onload = () => {
            const ctx = $('historyChart').getContext('2d');
            historyChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'ç­–ç•¥å‡†ç¡®ç‡', data: [], borderColor: '#10b981', tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            updateClock();
            loadHistory();
        };
    </script>
</body>
</html>